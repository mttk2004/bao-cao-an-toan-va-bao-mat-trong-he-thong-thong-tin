\chapter{PHÂN TÍCH VÀ THIẾT KẾ HỆ THỐNG}

Chương này đi sâu vào việc phân tích các yêu cầu chức năng và phi chức năng của hệ thống AuraCrypt, đồng thời trình bày chi tiết thiết kế kiến trúc, cơ sở dữ liệu và các quy trình xử lý nghiệp vụ quan trọng.

\section{Phân tích yêu cầu}

\subsection{Yêu cầu chức năng}
Hệ thống được thiết kế để đáp ứng các nhu cầu quản lý mật khẩu toàn diện của người dùng cá nhân, bao gồm các nhóm chức năng chính sau:

\begin{itemize}
    \item \textbf{Quản lý tài khoản và Xác thực:}
    \begin{itemize}
        \item Đăng ký và đăng nhập tài khoản qua Email (sử dụng Supabase Auth).
        \item Thiết lập và xác thực Mật khẩu chủ (Master Password) để mở khóa Két dữ liệu (Vault).
        \item Cơ chế khôi phục khẩn cấp (Reset Vault) khi quên mật khẩu chủ (chấp nhận mất dữ liệu để bảo vệ quyền riêng tư).
    \end{itemize}

    \item \textbf{Quản lý dữ liệu mật khẩu (CRUD):}
    \begin{itemize}
        \item Thêm mới, xem, chỉnh sửa và xóa các mục nhập (Entries).
        \item Hỗ trợ đa dạng loại dữ liệu: Tài khoản đăng nhập (Login), Thẻ ngân hàng (Credit Card), Thông tin danh tính (Identity).
        \item Tự động sao chép mật khẩu và tên đăng nhập vào clipboard.
    \end{itemize}

    \item \textbf{Tổ chức và Tìm kiếm:}
    \begin{itemize}
        \item Phân loại dữ liệu theo Danh mục (Categories) như: Công việc, Xã hội, Tài chính...
        \item Tìm kiếm thời gian thực theo tên dịch vụ hoặc tên đăng nhập.
    \end{itemize}

    \item \textbf{Công cụ bảo mật nâng cao:}
    \begin{itemize}
        \item \textbf{Password Generator:} Tạo mật khẩu ngẫu nhiên mạnh với độ dài và ký tự tùy chỉnh.
        \item \textbf{Health Check:} Phân tích độ mạnh của mật khẩu và kiểm tra lộ lọt dữ liệu.
        \item \textbf{Secure Sharing:} Chia sẻ mật khẩu an toàn qua liên kết tạm thời (Magic Link) có cơ chế tự hủy.
        \item \textbf{Auto-lock:} Tự động khóa két sau một khoảng thời gian không hoạt động.
    \end{itemize}

    \item \textbf{Tiện ích mở rộng:}
    \begin{itemize}
        \item Nhập/Xuất dữ liệu (Import/Export) định dạng CSV.
        \item Hỗ trợ giao diện Sáng/Tối (Light/Dark Theme) và Đa ngôn ngữ (Anh/Việt).
    \end{itemize}
\end{itemize}

\subsection{Yêu cầu phi chức năng}
\begin{itemize}
    \item \textbf{Bảo mật (Security):} Đây là yêu cầu quan trọng nhất. Hệ thống phải tuân thủ kiến trúc Zero-Knowledge. Dữ liệu nhạy cảm (mật khẩu, ghi chú) phải luôn được mã hóa trước khi rời khỏi trình duyệt.
    \item \textbf{Hiệu năng (Performance):} Quá trình mã hóa/giải mã phải diễn ra tức thì, không gây độ trễ đáng kể cho người dùng. Giao diện phải phản hồi nhanh (Responsive).
    \item \textbf{Tính sẵn sàng (Availability):} Dữ liệu phải được đồng bộ hóa và truy cập được từ mọi nơi thông qua trình duyệt web.
\end{itemize}

\section{Kiến trúc hệ thống}

\subsection{Mô hình tổng quan}
AuraCrypt Web hoạt động theo mô hình Client-Server nhưng với sự phân chia trách nhiệm đặc biệt về bảo mật.

\begin{figure}[H]
    \centering
    \includegraphics[width=1\textwidth]{images/kientruc_tongquan.png}
    \caption{Mô hình kiến trúc hệ thống AuraCrypt}
    \label{fig:architecture}
\end{figure}

\begin{itemize}
    \item \textbf{Client (Trình duyệt):} Đóng vai trò là "Vùng an toàn" (Trusted Zone). Tại đây diễn ra mọi hoạt động xử lý dữ liệu nhạy cảm:
    \begin{itemize}
        \item Nhập liệu từ người dùng.
        \item Dẫn xuất khóa (Key Derivation) từ Mật khẩu chủ.
        \item Mã hóa và Giải mã dữ liệu bằng Web Crypto API.
    \end{itemize}
    \item \textbf{Server (Supabase):} Đóng vai trò là "Kho chứa mù" (Untrusted Storage). Server chỉ thực hiện:
    \begin{itemize}
        \item Xác thực người dùng (cấp Session token).
        \item Lưu trữ và truy vấn các chuỗi dữ liệu đã mã hóa (Ciphertext).
        \item Thực thi các quy tắc phân quyền (Row Level Security).
    \end{itemize}
\end{itemize}

\subsection{Ranh giới tin cậy (Trust Boundary)}
Điểm khác biệt cốt lõi của AuraCrypt là ranh giới tin cậy nằm ngay tại thiết bị người dùng. Mật khẩu chủ (Master Password) và Khóa mã hóa (Encryption Key) không bao giờ vượt qua ranh giới này để đi vào môi trường mạng.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.65\textwidth]{images/trust_boundary.png}
    \caption{Sơ đồ Ranh giới tin cậy (Trust Boundary) trong AuraCrypt}
    \label{fig:trust_boundary}
\end{figure}

\section{Thiết kế cơ sở dữ liệu}

Cơ sở dữ liệu được thiết kế trên nền tảng PostgreSQL của Supabase. Do đặc thù bảo mật, thiết kế này phân tách rõ ràng giữa dữ liệu định danh (Metadata - có thể tìm kiếm) và dữ liệu bí mật (Secret Data - được mã hóa).

\begin{figure}[H]
    \centering
    \includegraphics[width=1\textwidth]{images/database_schema.png}
    \caption{Sơ đồ thực thể liên kết (ERD) của cơ sở dữ liệu AuraCrypt}
    \label{fig:erd}
\end{figure}

\subsection{Bảng \texttt{entries} (Lưu trữ mật khẩu)}
Đây là bảng chính lưu trữ thông tin các tài khoản của người dùng.

\begin{longtable}{|p{3.5cm}|p{2.5cm}|p{1.5cm}|p{6.5cm}|}
    \hline
    \textbf{Tên trường} & \textbf{Kiểu dữ liệu} & \textbf{Bắt buộc} & \textbf{Mô tả} \\
    \hline
    \texttt{id} & UUID & Có & Khóa chính, tự động sinh. \\
    \hline
    \texttt{user\_id} & UUID & Có & Khóa ngoại tham chiếu đến bảng \texttt{auth.users}. \\
    \hline
    \texttt{service\_name} & Text & Có & Tên dịch vụ (VD: Facebook, Google). Lưu dạng rõ để tìm kiếm. \\
    \hline
    \texttt{username} & Text & Không & Tên đăng nhập. Lưu dạng rõ để tìm kiếm. \\
    \hline
    \texttt{category} & Text & Không & Tên danh mục. \\
    \hline
    \texttt{encrypted\_password} & Text & Có & \textbf{Dữ liệu mật.} Chứa chuỗi Base64 của mật khẩu đã mã hóa. \\
    \hline
    \texttt{encrypted\_notes} & Text & Không & \textbf{Dữ liệu mật.} Chứa chuỗi Base64 của ghi chú kèm theo IV riêng (Format: \texttt{IV:Ciphertext}). \\
    \hline
    \texttt{iv} & Text & Có & Vector khởi tạo (Nonce) dùng cho việc giải mã trường password. \\
    \hline
    \texttt{created\_at} & Timestamptz & Có & Thời gian tạo. \\
    \hline
\end{longtable}

\subsection{Bảng \texttt{categories} (Quản lý danh mục)}
Lưu trữ danh sách các danh mục tùy chỉnh của người dùng.

\begin{longtable}{|p{3.5cm}|p{2.5cm}|p{1.5cm}|p{6.5cm}|}
    \hline
    \textbf{Tên trường} & \textbf{Kiểu dữ liệu} & \textbf{Bắt buộc} & \textbf{Mô tả} \\
    \hline
    \texttt{id} & UUID & Có & Khóa chính. \\
    \hline
    \texttt{user\_id} & UUID & Có & Chủ sở hữu danh mục. \\
    \hline
    \texttt{name} & Text & Có & Tên danh mục (VD: Work, Social). \\
    \hline
\end{longtable}

\subsection{Bảng \texttt{shared\_entries} (Chia sẻ bảo mật)}
Lưu trữ các gói dữ liệu mã hóa tạm thời phục vụ tính năng chia sẻ Magic Link.

\begin{longtable}{|p{3.5cm}|p{2.5cm}|p{1.5cm}|p{6.5cm}|}
    \hline
    \textbf{Tên trường} & \textbf{Kiểu dữ liệu} & \textbf{Bắt buộc} & \textbf{Mô tả} \\
    \hline
    \texttt{id} & UUID & Có & Khóa chính, dùng làm ID trong URL chia sẻ. \\
    \hline
    \texttt{encrypted\_data} & Text & Có & Dữ liệu JSON chứa thông tin chia sẻ đã được mã hóa bằng khóa tạm thời (Transient Key). \\
    \hline
    \texttt{iv} & Text & Có & Vector khởi tạo cho gói tin chia sẻ. \\
    \hline
    \texttt{views\_remaining} & Integer & Có & Số lượt xem còn lại (thường là 1 để tự hủy). \\
    \hline
    \texttt{expires\_at} & Timestamptz & Có & Thời gian hết hạn của liên kết. \\
    \hline
\end{longtable}

\section{Thiết kế luồng xử lý (Sequence Diagrams)}

\subsection{Quy trình Mở khóa Két (Vault Unlock)}
Quy trình này đảm bảo rằng chỉ khi người dùng nhập đúng Mật khẩu chủ, dữ liệu mới có thể được hiển thị.

\begin{enumerate}
    \item Người dùng nhập Mật khẩu chủ (Master Password) vào form mở khóa.
    \item Ứng dụng sử dụng \textbf{PBKDF2} để dẫn xuất ra Khóa mã hóa (Encryption Key).
    \item Ứng dụng tải về \textbf{một bản ghi mới nhất} từ bảng \texttt{entries} trên Supabase.
    \item Ứng dụng thử dùng Khóa vừa tạo để giải mã trường \texttt{encrypted\_password} của bản ghi đó bằng thuật toán \textbf{AES-GCM}.
    \item \textbf{Nếu giải mã thành công:} Khóa được xác nhận là đúng và được lưu vào bộ nhớ phiên (Session Storage). Người dùng được chuyển vào Dashboard.
    \item \textbf{Nếu giải mã thất bại (Exception):} Khóa sai. Ứng dụng báo lỗi "Sai mật khẩu" và không cho phép truy cập.
\end{enumerate}

\begin{figure}[H]
    \centering
    \includegraphics[width=1\textwidth]{images/sequence_unlock.png}
    \caption{Biểu đồ trình tự quy trình xác thực và mở khóa két}
    \label{fig:seq_unlock}
\end{figure}

\subsection{Quy trình Thêm mới Mật khẩu (Add Entry)}
\begin{enumerate}
    \item Người dùng nhập thông tin (Tên dịch vụ, Username, Password, Note) vào form.
    \item Ứng dụng sinh ngẫu nhiên một \textbf{IV (Initialization Vector)} 12 bytes.
    \item Sử dụng Khóa mã hóa trong bộ nhớ để mã hóa trường Password và Note bằng \textbf{AES-GCM}.
    \item Dữ liệu sau khi mã hóa (Ciphertext) được chuyển sang định dạng Base64.
    \item Ứng dụng đóng gói Metadata (Service name, Username - dạng rõ) và Ciphertext gửi lên API của Supabase.
    \item Supabase lưu trữ bản ghi và trả về xác nhận thành công.
\end{enumerate}

\begin{figure}[H]
    \centering
    \includegraphics[width=1\textwidth]{images/sequence_add_entry.png}
    \caption{Biểu đồ trình tự quy trình mã hóa và thêm mới mật khẩu}
    \label{fig:seq_add_entry}
\end{figure}

\subsection{Quy trình Chia sẻ An toàn (Secure Sharing)}
Đây là tính năng đặc biệt giúp chia sẻ mật khẩu mà không lộ khóa chủ.

\begin{enumerate}
    \item Client sinh ra một \textbf{Khóa tạm thời (Transient Key)} ngẫu nhiên.
    \item Dữ liệu cần chia sẻ được mã hóa bằng Khóa tạm thời này.
    \item Gói dữ liệu mã hóa (Ciphertext) được gửi lên Server (\texttt{shared\_entries}).
    \item Khóa tạm thời được chuyển thành chuỗi Base64 và ghép vào URL dưới dạng \textbf{Hash Fragment} (phần sau dấu \#).
    \item \textbf{Kết quả:} URL có dạng \texttt{domain.com/\#share?id=...\&key=...}. Vì phần Hash không bao giờ được gửi lên Server trong HTTP Request, Server không bao giờ biết được khóa giải mã.
\end{enumerate}

\section{Thiết kế giao diện người dùng (UI Design)}

Giao diện được thiết kế theo phong cách hiện đại (Modern UI), tối giản và tập trung vào trải nghiệm người dùng, hỗ trợ chế độ tối (Dark Mode) để giảm mỏi mắt.

\subsection{Màn hình Đăng nhập \& Mở khóa (Auth \& Vault Unlock)}
Giao diện đầu tiên người dùng tiếp cận. Được chia làm hai trạng thái:
\begin{itemize}
    \item \textbf{Xác thực tài khoản:} Form đăng nhập/đăng ký với Email.
    \item \textbf{Mở khóa Két:} Form nhập Mật khẩu chủ với biểu tượng ổ khóa lớn, tạo cảm giác an toàn.
\end{itemize}

% Chèn ảnh chụp màn hình thực tế
\begin{figure}[H]
    \centering
    \includegraphics[width=1\textwidth]{images/ui_login.png}
    \caption{Giao diện Đăng nhập/Đăng ký}
    \label{fig:ui_login}
\end{figure}

\begin{figure}[H]
    \centering
    \includegraphics[width=1\textwidth]{images/ui_unlock.png}
    \caption{Giao diện Mở khóa Két (Vault Unlock)}
    \label{fig:ui_unlock}
\end{figure}

\noindent \textbf{Mô tả giao diện:}
\begin{itemize}
    \item \textbf{Giao diện Đăng nhập (Hình \ref{fig:ui_login}):} Thiết kế tối giản, tập trung vào khung nhập liệu. Người dùng có thể chuyển đổi linh hoạt giữa Đăng nhập và Đăng ký.
    \item \textbf{Giao diện Mở khóa (Hình \ref{fig:ui_unlock}):} Sử dụng Modal (hộp thoại) nổi bật trên nền tối mờ để tập trung sự chú ý. Biểu tượng ổ khóa thay đổi trạng thái tùy theo chế độ (Setup hoặc Unlock). Nút "Reset Vault" được bố trí tinh tế để hỗ trợ trường hợp khẩn cấp.
\end{itemize}

\subsection{Màn hình Chính (Dashboard)}
Trung tâm điều khiển của ứng dụng, bao gồm:
\begin{itemize}
    \item \textbf{Sidebar:} Điều hướng danh mục và các công cụ tiện ích.
    \item \textbf{Thanh tìm kiếm:} Tìm kiếm thời gian thực.
    \item \textbf{Danh sách thẻ (Grid/List view):} Hiển thị các tài khoản dưới dạng thẻ trực quan với logo thương hiệu (Favicon) tự động lấy từ URL.
\end{itemize}

\begin{figure}[H]
    \centering
    \includegraphics[width=1\textwidth]{images/ui_dashboard.png}
    \caption{Giao diện Dashboard}
    \label{fig:ui_dashboard}
\end{figure}

\subsection{Màn hình Thêm/Sửa (Entry Modal)}
Modal popup cho phép nhập liệu chi tiết.
\begin{itemize}
    \item Tự động gợi ý danh mục và icon dựa trên tên dịch vụ.
    \item Tích hợp công cụ sinh mật khẩu mạnh ngay trong ô nhập liệu.
    \item Hiển thị cảnh báo nếu người dùng nhập một mật khẩu yếu.
\end{itemize}

\begin{figure}[H]
    \centering
    \includegraphics[width=1\textwidth]{images/ui_add_entry.png}
    \caption{Giao diện Thêm/Sửa (Entry Modal)}
    \label{fig:ui_add_entry}
\end{figure}

\subsection{Màn hình Quản lý Danh mục (Category Manager)}
Để giúp người dùng tổ chức dữ liệu một cách khoa học, hệ thống cung cấp giao diện quản lý danh mục tùy chỉnh.
\begin{itemize}
    \item \textbf{Danh sách danh mục:} Hiển thị tất cả các danh mục hiện có (bao gồm danh mục mặc định và danh mục do người dùng tạo).
    \item \textbf{Thao tác:} Cho phép thêm mới danh mục nhanh chóng và xóa các danh mục không còn sử dụng. Khi xóa một danh mục, hệ thống sẽ tự động xử lý các mục nhập (entries) thuộc danh mục đó để đảm bảo toàn vẹn dữ liệu.
\end{itemize}

\begin{figure}[H]
    \centering
    \includegraphics[width=1\textwidth]{images/ui_category_manager.png}
    \caption{Giao diện Quản lý Danh mục}
    \label{fig:ui_category_manager}
\end{figure}

\subsection{Màn hình Kiểm tra Sức khỏe Mật khẩu (Password Health)}
Đây là tính năng bảo mật nâng cao giúp người dùng đánh giá tổng quan về độ an toàn của kho dữ liệu. Giao diện được thiết kế trực quan với các biểu đồ và màu sắc cảnh báo.
\begin{itemize}
    \item \textbf{Điểm bảo mật (Security Score):} Biểu đồ tròn hiển thị điểm số tổng thể (0-100) dựa trên độ mạnh và tính duy nhất của các mật khẩu.
    \item \textbf{Phân tích chi tiết:} Phân loại các rủi ro thành các nhóm:
    \begin{itemize}
        \item \textbf{Bị lộ (Compromised):} Phát hiện qua API k-Anonymity.
        \item \textbf{Tái sử dụng (Reused):} Các tài khoản dùng chung một mật khẩu.
        \item \textbf{Yếu (Weak):} Mật khẩu quá ngắn hoặc thiếu độ phức tạp.
    \end{itemize}
\end{itemize}

\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\textwidth]{images/ui_health_check.png}
    \caption{Giao diện Báo cáo Sức khỏe Mật khẩu}
    \label{fig:ui_health_check}
\end{figure}

\subsection{Màn hình Cài đặt (Settings)}
Giao diện cài đặt được tổ chức thành 3 thẻ (tabs) riêng biệt để người dùng dễ dàng cấu hình hệ thống theo nhu cầu:

\begin{itemize}
    \item \textbf{Chung (General):}
    \begin{itemize}
        \item Cấu hình thời gian tự động khóa (Auto-lock timer) để bảo vệ dữ liệu khi người dùng rời khỏi máy tính.
    \end{itemize}
    
    \item \textbf{Bảo mật (Security):}
    \begin{itemize}
        \item \textbf{Đổi Mật khẩu chủ:} Tính năng quan trọng nhất. Quy trình này yêu cầu nhập mật khẩu cũ để xác thực, sau đó hệ thống sẽ thực hiện giải mã toàn bộ dữ liệu và mã hóa lại bằng mật khẩu mới (Re-encryption) ngay tại phía máy khách.
    \end{itemize}
    
    \item \textbf{Dữ liệu (Data):}
    \begin{itemize}
        \item \textbf{Xuất dữ liệu (Export):} Cho phép tải toàn bộ kho dữ liệu về máy dưới dạng file CSV (không mã hóa) để sao lưu offline.
        \item \textbf{Nhập dữ liệu (Import):} Hỗ trợ nhập hàng loạt tài khoản từ file CSV, tự động mã hóa và đẩy lên cơ sở dữ liệu.
    \end{itemize}
\end{itemize}

\begin{figure}[H]
    \centering
    \includegraphics[width=1\textwidth]{images/ui_settings_general.png}
    \caption{Giao diện Cài đặt - Thẻ Chung}
    \label{fig:ui_settings_general}
\end{figure}

\begin{figure}[H]
    \centering
    \includegraphics[width=1\textwidth]{images/ui_settings_security.png}
    \caption{Giao diện Cài đặt - Thẻ Bảo mật (Đổi mật khẩu chủ)}
    \label{fig:ui_settings_security}
\end{figure}

\begin{figure}[H]
    \centering
    \includegraphics[width=1\textwidth]{images/ui_settings_data.png}
    \caption{Giao diện Cài đặt - Thẻ Dữ liệu (Import/Export)}
    \label{fig:ui_settings_data}
\end{figure}

\subsection{Màn hình Giới thiệu (About)}
Cung cấp thông tin minh bạch về ứng dụng để xây dựng niềm tin với người dùng.
\begin{itemize}
    \item Hiển thị phiên bản phần mềm hiện tại.
    \item Giải thích ngắn gọn về kiến trúc Zero-Knowledge và quy trình mã hóa đang được áp dụng.
    \item Liệt kê các công nghệ lõi (Tech Stack) được sử dụng trong dự án.
    \item Thông tin liên hệ của tác giả và liên kết đến mã nguồn (nếu có).
\end{itemize}

\begin{figure}[H]
    \centering
    \includegraphics[width=1\textwidth]{images/ui_about.png}
    \caption{Giao diện Giới thiệu thông tin ứng dụng}
    \label{fig:ui_about}
\end{figure}